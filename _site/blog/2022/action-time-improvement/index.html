<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>GitHub action's execution time | Fabrizio  Sandri</title>
    <meta name="author" content="Fabrizio  Sandri" />
    <meta name="description" content="Description of the steps that I will follow this week to improve the GitHub action's execution time" />
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/monokai.css" media="none" id="highlight_theme_light" />

    <!-- Styles -->
    
    <link rel="shortcut icon" href="/assets/img/favicon.ico"/>
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://localhost:4000/blog/2022/action-time-improvement/">
    
    <!-- Dark Mode -->
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Fabrizio </span>Sandri</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">About</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">Projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">Curriculum</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">GitHub action's execution time</h1>
    <p class="post-meta">July 25, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
        ·  
        <a href="/blog/tag/github-action">
          <i class="fas fa-hashtag fa-sm"></i> GitHub Action</a>  
          

    </p>
  </header>

  <article class="post-content">
    <h2 id="introduction">Introduction</h2>
<p>In the previous week I successfully integrated the original Docker action with a composite one. The main result of this update is a more flexible action that makes possible to publish the analysis results on Github; this is possible by publishing an artifact file containing the inputs and adding comments to pull requests. In the past working week (Week 7) I discussed with my mentor Randy about this change and he suggested me to prebuild the entire action and upload it to Docker Hub, which is a service provided by Docker for sharing container images<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup>. In this blog post I describe the process that will be followed this week, in order to prebuild the Docker image and publish it to Docker Hub.</p>

<h2 id="considerations">Considerations</h2>
<p>The actual execution time of the Action is about 15-30 minutes. A huge amount of this time is spent installing all the missing dependencies, which includes the R package, devtools, and so on. Installing each of these every time the action is triggered is useless. A better approach instead would be to prebuild the docker container and save the image so that it can be reused each time the action will be run. This can be accomplished by publishing the image on Docker Hub. What I expect from this improvement is a reduction of the amount of time spent installing the dependencies.</p>

<p>One last thing to think about is moving the devtools installation command from the <code class="language-plaintext highlighter-rouge">entrypoint.sh</code> file to the Dockerfile so that it will be installed when the container is built.</p>

<h2 id="switch-to-a-prebuilt-docker-image">Switch to a prebuilt docker image</h2>
<p>The main idea is to replace the actual Action’s Dockerfile with a simple composite step that runs the image from Docker Hub.</p>

<p>In the actual implementation, every time the Action is triggered, a container is built in accordance with the Dockerfile, downloading each dependency one at a time, as you can see in the Dockerfile of the following sample.</p>
<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="s"> ubuntu:latest</span>

<span class="c"># setup zoneinfo</span>
<span class="k">RUN </span><span class="nb">ln</span> <span class="nt">-snf</span> /usr/share/zoneinfo/<span class="nv">$INPUT_ZONEINFO</span> /etc/localtime <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="nv">$INPUT_ZONEINFO</span> <span class="o">&gt;</span> /etc/timezone

<span class="c">### Dependencies installation</span>
<span class="k">RUN </span>apt update
<span class="k">RUN </span>apt <span class="nb">install</span> <span class="nt">-y</span> build-essential gcc-multilib g++-multilib cmake <span class="se">\
</span>                   python3-setuptools python3-dev libffi-dev clang valgrind <span class="se">\
</span>                   libcurl4-gnutls-dev libxml2-dev libssl-dev wget <span class="se">\
</span>                   libfontconfig1-dev libharfbuzz-dev libfribidi-dev <span class="se">\
</span>                   libfreetype6-dev libpng-dev libtiff5-dev libjpeg-dev r-base

<span class="c"># Copy the files to the root filesystem of the container</span>
<span class="k">COPY</span><span class="s"> src/entrypoint.sh /entrypoint.sh</span>
<span class="k">COPY</span><span class="s"> src/analyze_package.R /analyze_package.R</span>
<span class="k">RUN </span><span class="nb">chmod</span> +x /entrypoint.sh

<span class="c"># Executes `entrypoint.sh` when the Docker container starts up</span>
<span class="k">ENTRYPOINT</span><span class="s"> ["/entrypoint.sh"]</span>
</code></pre></div></div>

<p>The new composite step will make use of the prebuilt image made available on Docker Hub. The dependencies are all installed in this image, so setting them up won’t take any time; the only overhead will be caused by downloading the prebuilt action. This is the <code class="language-plaintext highlighter-rouge">action.yml</code> before the change.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
<span class="na">runs</span><span class="pi">:</span>
  <span class="na">using</span><span class="pi">:</span> <span class="s2">"</span><span class="s">composite"</span>
  <span class="na">steps</span><span class="pi">:</span>

    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v2</span> 
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">repository</span><span class="pi">:</span> <span class="s">FabrizioSandri/RcppDeepState-action</span>
        <span class="na">path</span><span class="pi">:</span> <span class="s">RcppDeepState-action</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Analyze the package with RcppDeepState</span> 
      <span class="na">uses</span><span class="pi">:</span> <span class="s">./RcppDeepState-action/docker</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">fail_ci_if_error</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">location</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">seed</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">time_limit</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">max_inputs</span><span class="pi">:</span> <span class="s">$</span>
<span class="nn">...</span>
</code></pre></div></div>

<p>After the change, it will look like this:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">...</span>
<span class="na">runs</span><span class="pi">:</span>
  <span class="na">using</span><span class="pi">:</span> <span class="s2">"</span><span class="s">composite"</span>
  <span class="na">steps</span><span class="pi">:</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Analyze the package with RcppDeepState</span> 
      <span class="na">uses</span><span class="pi">:</span> <span class="s">docker://fabriziosandri/rcppdeepstate:latest</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">fail_ci_if_error</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">location</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">seed</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">time_limit</span><span class="pi">:</span> <span class="s">$</span>
        <span class="na">max_inputs</span><span class="pi">:</span> <span class="s">$</span>
<span class="nn">...</span>
</code></pre></div></div>
<p>As you can see the <code class="language-plaintext highlighter-rouge">checkout</code> step has been removed, in fact there’s no need to download the Dockerfile and the related files(<code class="language-plaintext highlighter-rouge">/docker</code> folder). This solves the problem of specifying the branch name in the checkout step mentioned by Randy in the pull request #4<sup id="fnref:3" role="doc-noteref"><a href="#fn:3" class="footnote" rel="footnote">2</a></sup>. However this introduces a new problem: I have to decide which event should trigger the update of the image on Docker Hub. A possible solution for this problem is to update the image every time a new commit on the master branch occurs. The problem with this solution is that, if I make a pull request and want to test some new updates made on the docker image, I have to push the result on the master branch to trigger the update on Docker Hub.</p>

<h2 id="continuous-deploy-of-the-docker-image">Continuous deploy of the Docker image</h2>
<p>Each change to the Docker architecture must be reflected to the image published on Docker Hub. In order to make this process automatic and avoid to manually push the docker image to Docker Hub, as suggested by Randy, there is an existing GitHub Action that automatically builds and publishes Docker images to Docker Hub<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">3</a></sup>. This action can be integrated in the RcppDeepState-action repository inside a workflow’s job that is triggered every time a commit on the master branch occurs.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">jobs</span><span class="pi">:</span>
  <span class="na">docker</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">ubuntu-latest</span>
    <span class="na">steps</span><span class="pi">:</span>

      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Checkout</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v3</span>
      
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Docker Buildx</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/setup-buildx-action@v2</span>
      
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Login to DockerHub</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/login-action@v2</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">username</span><span class="pi">:</span> <span class="s">$</span>
          <span class="na">password</span><span class="pi">:</span> <span class="s">$</span>
    
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Build and push</span>
        <span class="na">uses</span><span class="pi">:</span> <span class="s">docker/build-push-action@v3</span>
        <span class="na">with</span><span class="pi">:</span>
          <span class="na">context</span><span class="pi">:</span> <span class="s">./docker</span>
          <span class="na">push</span><span class="pi">:</span> <span class="no">true</span>
          <span class="na">tags</span><span class="pi">:</span> <span class="s">fabriziosandri/rcppdeepstate:latest</span>
</code></pre></div></div>

<p>A token must be generated in order to publish the image to Docker Hub and authenticate the user before pushing the image on it. This token can be simply generated by going in Profile Settings &gt; Security &gt; Access Tokens &gt; New Access Token. A pop up will appear, asking for the permissions that will be assigned to this token; the value “Read, Write, Delete” is sufficient.</p>

<p>In order to prevent information theft, the token and the username should be kept as a repository secret. In the example above, the variables for the username and token are referred to as <code class="language-plaintext highlighter-rouge">DOCKERHUB_USERNAME</code> and <code class="language-plaintext highlighter-rouge">DOCKERHUB_TOKEN</code> respectively. These parameters have been set in the Security &gt; Secrets &gt; Actions menu on the Settings tab of the repository.
Once they are defined, they can be used in the following way<code class="language-plaintext highlighter-rouge"> $</code>.</p>

<hr>

<div class="footnotes" role="doc-endnotes">
  <ol>
    <li id="fn:1" role="doc-endnote">
      <p><a href="https://hub.docker.com/" target="_blank" rel="noopener noreferrer">Docker Hub</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p>
    </li>
    <li id="fn:3" role="doc-endnote">
      <p><a href="https://github.com/FabrizioSandri/RcppDeepState-action/pull/4#issuecomment-1183670955" target="_blank" rel="noopener noreferrer">Composite action #4</a> <a href="#fnref:3" class="reversefootnote" role="doc-backlink">↩</a></p>
    </li>
    <li id="fn:2" role="doc-endnote">
      <p><a href="https://github.com/marketplace/actions/build-and-push-docker-images" target="_blank" rel="noopener noreferrer">GitHub Action - Build and push Docker images</a> <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p>
    </li>
  </ol>
</div>

  </article>

</div>

    </div>

    <!-- Footer -->
    <!--    <footer class="sticky-bottom mt-5">
      <div class="container">
        &copy; Copyright 2022 Fabrizio  Sandri. 
      </div>
    </footer> -->

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
  </body>
</html>
