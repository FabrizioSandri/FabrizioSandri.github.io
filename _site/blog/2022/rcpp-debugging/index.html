<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Debugging Rcpp outside of R | Fabrizio  Sandri</title>
    <meta name="author" content="Fabrizio  Sandri" />
    <meta name="description" content="A detailed description of debugging Rcpp functions outside of the R environment using Valgrind" />
    <meta name="keywords" content="jekyll, jekyll-theme, academic-website, portfolio-website" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/monokai.css" media="none" id="highlight_theme_light" />

    <!-- Styles -->
    
    <link rel="shortcut icon" href="/assets/img/favicon.ico"/>
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="http://localhost:4000/blog/2022/rcpp-debugging/">
    
    <!-- Dark Mode -->
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav sticky-bottom-footer">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Fabrizio </span>Sandri</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">About</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item active">
                <a class="nav-link" href="/blog/">Blog<span class="sr-only">(current)</span></a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">Projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/cv/">Curriculum</a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- _layouts/post.html -->

<div class="post">

  <header class="post-header">
    <h1 class="post-title">Debugging Rcpp outside of R</h1>
    <p class="post-meta">June 10, 2022</p>
    <p class="post-tags">
      <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>
        ·  
        <a href="/blog/tag/rcpp">
          <i class="fas fa-hashtag fa-sm"></i> Rcpp</a>  
          <a href="/blog/tag/valgrind">
          <i class="fas fa-hashtag fa-sm"></i> Valgrind</a>  
          

    </p>
  </header>

  <article class="post-content">
    <h1 id="introduction">Introduction</h1>
<p>Sometimes it could be necessary to test your Rcpp defined code using an external tool, like Valgrind or GDB. This process however will almost likely come to a crash of your program with a strange Segmentation Fault error. The error is due to the fact that executing Rcpp code is only possible within a working R environment. I talked about this with a Rcpp community member and his answer is reported in this issue <a href="https://github.com/RcppCore/Rcpp/issues/1221" target="_blank" rel="noopener noreferrer">#1221</a>.</p>

<blockquote>
  <p>“All” that <code class="language-plaintext highlighter-rouge">Rcpp</code> does is to provide <code class="language-plaintext highlighter-rouge">R</code> with callable code via the <code class="language-plaintext highlighter-rouge">.Call()</code> interface which is meant to <em>extend a running R session</em>. Nowhere in the <code class="language-plaintext highlighter-rouge">R</code> (or <code class="language-plaintext highlighter-rouge">Rcpp</code>) documentation is it hinted that you can run code separately. Which is why we run all tests etc from <code class="language-plaintext highlighter-rouge">R</code>.</p>
</blockquote>

<p>So, the question might appear straightforward, but is it feasible to run Rcpp code outside of a R environment?
Using RInside, the answer is yes.</p>

<h2 id="proof-of-concept">Proof of concept</h2>
<p>Imagine you have the following <code class="language-plaintext highlighter-rouge">bootstrap</code> function and want to simply execute it and get the result, that you expect to be <code class="language-plaintext highlighter-rouge">10</code>.</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
</span>
<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">bootstrap</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Allocate a sample NumericVector</span>
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">NumericVector</span> <span class="n">sample</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">};</span>
    
    <span class="k">return</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">bootstrap</span><span class="p">()</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>If you try to compile and execute this program however the result is quite different:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>g++ <span class="nt">-lR</span> <span class="nt">-I</span><span class="s2">"/usr/include/R/"</span> <span class="nt">-I</span>/usr/local/include  <span class="nt">-I</span><span class="s2">"/home/fabri/R/x86_64-pc-linux-gnu-library/4.2/Rcpp/include"</span> <span class="nt">-L</span>/usr/lib64/R/lib <span class="nt">-o</span> bootstrap bootstrap.cpp
<span class="nv">$ </span> ./bootstrap
<span class="o">[</span>1]    23848 segmentation fault <span class="o">(</span>core dumped<span class="o">)</span>  ./bootstrap
</code></pre></div></div>

<h3 id="solution">Solution</h3>
<p>The solution is to embed in your code a working R environment within the process. This can be done using the powerful RInside library. All you have to do is to include the header files and create an embedded R instance. The preceding example will be modified as follows:</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RInside.h&gt;</span><span class="cp">
</span>
<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">bootstrap</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">RInside</span> <span class="n">R</span><span class="p">;</span>
    <span class="c1">// Allocate a sample NumericVector</span>
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">NumericVector</span> <span class="n">sample</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span><span class="mi">20</span><span class="p">,</span><span class="mi">30</span><span class="p">,</span><span class="mi">40</span><span class="p">,</span><span class="mi">50</span><span class="p">};</span>
    
    <span class="k">return</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[]){</span>
    <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">bootstrap</span><span class="p">()</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>There will be no errors if you try to compile and run the program after this update.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>g++ <span class="nt">-g</span> <span class="nt">-lR</span> <span class="nt">-lRInside</span> <span class="nt">-I</span><span class="s2">"/usr/include/R/"</span> <span class="nt">-I</span>/usr/local/include <span class="nt">-I</span>/usr/lib/R/library/RInside/include <span class="nt">-I</span><span class="s2">"/home/fabri/R/x86_64-pc-linux-gnu-library/4.2/Rcpp/include"</span> <span class="nt">-L</span>/usr/lib/R/library/RInside/lib <span class="nt">-Wl</span>,-rpath<span class="o">=</span>/usr/lib/R/library/RInside/lib <span class="nt">-L</span>/usr/lib64/R/lib <span class="nt">-o</span> bootstrap bootstrap.cpp
<span class="nv">$ </span> ./bootstrap
10
</code></pre></div></div>

<h2 id="debugging-with-deepstate-and-valgrind">Debugging with Deepstate and valgrind</h2>
<p>Now that we have all of the necessary tools, we can start developing our first Rcpp function test harness. Imagine that we want to fuzz test a function named <code class="language-plaintext highlighter-rouge">getFirstElement</code> that returns the first element of an Rcpp IntegerVector. Deepstate might be used to send some randomly initialized vectors to this method in order to discover any memory issues. To do this, we may create a basic test harness that employs a function that produces a random integer vector, in this instance <code class="language-plaintext highlighter-rouge">randomIntegerVector</code>, and then passes that vector to the <code class="language-plaintext highlighter-rouge">getFirstElement</code> function. This is the final result.</p>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;Rcpp.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;RInside.h&gt;</span><span class="cp">
</span>
<span class="cp">#include</span> <span class="cpf">&lt;deepstate/DeepState.hpp&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">deepstate</span><span class="p">;</span>

<span class="c1">// [[Rcpp::export]]</span>
<span class="kt">int</span> <span class="nf">getFirstElement</span><span class="p">(</span><span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">){</span>
        <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// random IntegerVector generation procedure</span>
<span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">randomIntegerVector</span><span class="p">(</span><span class="kt">int</span> <span class="n">maxSize</span><span class="p">){</span>

    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">maxSize</span><span class="p">);</span>
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">vec</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">){</span>
        <span class="n">vec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeepState_IntInRange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1000</span><span class="p">);</span>
    <span class="p">}</span>
  
    <span class="k">return</span> <span class="n">vec</span><span class="p">;</span>
<span class="p">}</span>


<span class="n">TEST</span><span class="p">(</span><span class="n">Unit</span><span class="p">,</span> <span class="n">name</span><span class="p">){</span>
    <span class="k">static</span> <span class="n">RInside</span> <span class="n">R</span><span class="p">;</span>
    
    <span class="n">Rcpp</span><span class="o">::</span><span class="n">IntegerVector</span> <span class="n">randomVec</span> <span class="o">=</span> <span class="n">randomIntegerVector</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

    <span class="n">getFirstElement</span><span class="p">(</span><span class="n">randomVec</span><span class="p">);</span>

<span class="p">}</span>
</code></pre></div></div>

<p>It’s worth noting that the RInside instance has been defined as static, this will prevent error such as <code class="language-plaintext highlighter-rouge">R is already initialized</code>. Making the <code class="language-plaintext highlighter-rouge">R</code> variable static force the application to use the same RInside object for all of the application’s lifetime.</p>

<p>Let’s now compile the harness and run it with the Valgrind Memcheck tool</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>g++ <span class="nt">-g</span> <span class="nt">-ldeepstate</span> <span class="nt">-lR</span> <span class="nt">-lRInside</span> <span class="nt">-I</span><span class="s2">"/usr/include/R/"</span> <span class="nt">-I</span>/usr/local/include <span class="nt">-I</span>/usr/lib/R/library/RInside/include <span class="nt">-I</span><span class="s2">"/home/fabri/R/x86_64-pc-linux-gnu-library/4.2/Rcpp/include"</span> <span class="nt">-L</span>/usr/lib/R/library/RInside/lib <span class="nt">-Wl</span>,-rpath<span class="o">=</span>/usr/lib/R/library/RInside/lib <span class="nt">-L</span>/usr/lib64/R/lib <span class="nt">-o</span> getFirstElement getFirstElement.cpp
<span class="nv">$ </span>valgrind  ./getFirstElement <span class="nt">--fuzz</span> <span class="nt">--timeout</span><span class="o">=</span>10
</code></pre></div></div>

<p>This will be the result</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="s">==43210== Memcheck, a memory error detector</span>
<span class="s">==43210== Copyright (C) 2002-2022, and GNU GPL'd, by Julian Seward et al.</span>
<span class="s">==43210== Using Valgrind-3.19.0 and LibVEX; rerun with -h for copyright info</span>
<span class="na">==43210== Command</span><span class="pi">:</span> <span class="s">./getFirstElement --fuzz --timeout=10</span>
<span class="s">==43210==</span> 
<span class="na">INFO</span><span class="pi">:</span> <span class="s">Starting fuzzing</span>
<span class="na">WARNING</span><span class="pi">:</span> <span class="s">No seed provided; using </span><span class="m">1654880923</span>
<span class="na">WARNING</span><span class="pi">:</span> <span class="s">No test specified, defaulting to first test defined (Unit_name)</span>
<span class="na">INFO</span><span class="pi">:</span> <span class="s">Done fuzzing! Ran 1828 tests (182 tests/second) with 0 failed/1828 passed/0 abandoned tests</span>
<span class="s">==43210==</span> 
<span class="na">==43210== HEAP SUMMARY</span><span class="pi">:</span>
<span class="na">==43210==     in use at exit</span><span class="pi">:</span> <span class="s">51,299,862 bytes in 9,936 blocks</span>
<span class="na">==43210==   total heap usage</span><span class="pi">:</span> <span class="s">30,813 allocs, 20,877 frees, 87,993,209 bytes allocated</span>
<span class="s">==43210==</span> 
<span class="na">==43210== LEAK SUMMARY</span><span class="pi">:</span>
<span class="na">==43210==    definitely lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==43210==    indirectly lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==43210==      possibly lost</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="na">==43210==    still reachable</span><span class="pi">:</span> <span class="s">51,299,862 bytes in 9,936 blocks</span>
<span class="na">==43210==                       of which reachable via heuristic</span><span class="pi">:</span>
<span class="na">==43210==                         newarray           </span><span class="pi">:</span> <span class="s">4,264 bytes in 1 blocks</span>
<span class="na">==43210==         suppressed</span><span class="pi">:</span> <span class="s">0 bytes in 0 blocks</span>
<span class="s">==43210== Rerun with --leak-check=full to see details of leaked memory</span>
<span class="s">==43210==</span> 
<span class="s">==43210== For lists of detected and suppressed errors, rerun with</span><span class="err">:</span> <span class="s">-s</span>
<span class="na">==43210== ERROR SUMMARY</span><span class="pi">:</span> <span class="na">0 errors from 0 contexts (suppressed</span><span class="pi">:</span> <span class="s">0 from 0)</span>
</code></pre></div></div>

<h1 id="conclusion">Conclusion</h1>
<p>We were able to run a debugging tool, specifically the Valgrind suite’s Memcheck tool. This demonstrates how integrating many techniques may be an effective method of solving a problem.</p>

  </article>

</div>

    </div>

    <!-- Footer -->
    <!--    <footer class="sticky-bottom mt-5">
      <div class="container">
        &copy; Copyright 2022 Fabrizio  Sandri. 
      </div>
    </footer> -->

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    
    
  <!-- Medium Zoom JS -->
  <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script defer src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script defer src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
  </body>
</html>
